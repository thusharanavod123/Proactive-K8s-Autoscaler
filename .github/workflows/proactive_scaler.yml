name: Proactive K8s Scaler Simulation
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  proactive-scaling:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Machine Learning Dependencies
        run: |
          pip install pandas numpy tensorflow scikit-learn

      - name: Run Proactive Prediction Logic
        run: |
          python <<EOF
          import pandas as pd
          import numpy as np
          from tensorflow.keras.models import load_model
          import os

          # 1. Load Model
          model_path = 'models/synthetic_stress_test.csv'
          if os.path.exists(model_path):
              model = load_model(model_path, compile=False)
              print("âœ… Model loaded.")
          else:
              print(f"âŒ Error: Model missing at {model_path}")
              exit(1)

          # 2. Load Data
          data_path = 'data/google_cluster_10k_minimal.csv'
          if os.path.exists(data_path):
              data = pd.read_csv(data_path)
          else:
              print(f"âŒ Error: Data missing at {data_path}")
              exit(1)

          # 3. Predict
          last_6_points = data['cpu_usage'].tail(6).values.reshape(1, 6, 1)
          prediction = model.predict(last_6_points)
          predicted_cpu = float(prediction[0][0])

          # 4. Report
          THRESHOLD = 0.5 
          print(f"Predicted CPU: {predicted_cpu:.4f}")
          if predicted_cpu > THRESHOLD:
              print("ðŸš¨ RESULT: SPIKE PREDICTED. Scaling Up!")
          else:
              print("âœ… RESULT: STABLE. No action needed.")
          EOF

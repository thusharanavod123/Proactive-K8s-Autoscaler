name: Proactive K8s Scaler Simulation
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  proactive-scaling:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Machine Learning Dependencies
        run: |
          pip install pandas numpy tensorflow scikit-learn

      - name: Debug - List Files in Repo
        run: |
          echo "Listing all files to check paths:"
          ls -R

      - name: Run Proactive Prediction Logic
        run: |
          python <<EOF
          import pandas as pd
          import numpy as np
          from tensorflow.keras.models import load_model
          import os

          # Define Paths
          model_path = 'models/proactive_model_google_v1.h5'
          data_path = 'data/synthetic_stress_test.csv'

          # Check Model
          if os.path.exists(model_path):
              model = load_model(model_path, compile=False)
              print("✅ Brain (.h5) found and loaded.")
          else:
              print(f"❌ ERROR: Cannot find {model_path}")
              exit(1)

          # Check Data
          if os.path.exists(data_path):
              data = pd.read_csv(data_path)
              print(f"✅ Data (.csv) found and loaded.")
          else:
              print(f"❌ ERROR: Cannot find {data_path}")
              exit(1)

          # Predict
          last_6_points = data['cpu_usage'].tail(6).values.reshape(1, 6, 1)
          prediction = model.predict(last_6_points)
          print(f"--- RESULT ---")
          print(f"Predicted CPU: {prediction[0][0]:.4f}")
          EOF
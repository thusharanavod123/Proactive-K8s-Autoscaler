name: Proactive K8s Scaler Simulation
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  proactive-scaling:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Machine Learning Dependencies
        run: |
          pip install pandas numpy tensorflow scikit-learn

      - name: Run Proactive Prediction Logic
        run: |
          python <<EOF
          import pandas as pd
          import numpy as np
          from tensorflow.keras.models import load_model
          import os

          # 1. Paths
          model_path = 'models/proactive_model_google_v1.h5'
          data_path = 'data/synthetic_stress_test.csv'

          # 2. Safety Checks
          if not os.path.exists(model_path) or not os.path.exists(data_path):
              print("âŒ ERROR: Files missing in repo folders!")
              exit(1)

          # 3. Load Model
          model = load_model(model_path, compile=False)
          print("âœ… Model (Brain) Loaded.")

          # 4. Load Data and Select EXACT 3 Columns
          data = pd.read_csv(data_path)
          
          # This ensures the order is ALWAYS CPU, MEM, TIMESTAMP
          # Match these names to your CSV header exactly!
          features = data[['cpu_usage', 'memory_usage', 'timestamp']].tail(6).values
          
          # 5. Reshape to (1 Sample, 6 Time steps, 3 Features)
          prediction_input = features.reshape(1, 6, 3)
          
          # 6. Predict
          prediction = model.predict(prediction_input)
          predicted_val = float(prediction[0][0])

          print(f"\n--- SUCCESS ---")
          print(f"Predicted Next CPU Load: {predicted_val:.4f}")
          if predicted_val > 0.5:
              print("ðŸš¨ ALERT: Scaling Up!")
          else:
              print("âœ… STATUS: Stable.")
          EOF
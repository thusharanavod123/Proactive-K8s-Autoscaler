name: Proactive K8s Scaler Simulation
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  proactive-scaling:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Machine Learning Dependencies
        run: |
          pip install pandas numpy tensorflow scikit-learn

      - name: Run Proactive Prediction Logic
        run: |
          python <<EOF
            import pandas as pd
            import numpy as np
            from tensorflow.keras.models import load_model
            import os

            # 1. FIXED: Point to the REAL .h5 model file
            model_path = 'models/proactive_model_google_v1.h5'
            
            # 2. FIXED: Point to the SYNTHETIC .csv data file
            data_path = 'data/synthetic_stress_test.csv'

            # Check if Model exists
            if os.path.exists(model_path):
                model = load_model(model_path, compile=False)
                print(f"âœ… Brain loaded from {model_path}")
            else:
                print(f"âŒ Error: Model (.h5) missing at {model_path}")
                exit(1)

            # Check if Data exists
            if os.path.exists(data_path):
                data = pd.read_csv(data_path)
                print(f"âœ… Data loaded from {data_path}")
            else:
                print(f"âŒ Error: Data (.csv) missing at {data_path}")
                exit(1)

            # 3. Use data to predict
            last_6_points = data['cpu_usage'].tail(6).values.reshape(1, 6, 1)
            prediction = model.predict(last_6_points)
            predicted_cpu = float(prediction[0][0])
            print(f"Prediction: {predicted_cpu}")
            

            # 4. Scaling Decision Report
            THRESHOLD = 0.5 
            print(f"\n--- SYNTHETIC STRESS TEST REPORT ---")
            print(f"Predicted CPU Demand: {predicted_cpu:.4f}")
            if predicted_cpu > THRESHOLD:
                print("ðŸš¨ RESULT: SPIKE DETECTED. Action: Scaling up Pods!")
            else:
                print("âœ… RESULT: STABLE. Action: No scaling needed.")
          EOF

name: Proactive K8s Scaler Simulation
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  proactive-scaling:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Machine Learning Dependencies
        run: |
          pip install pandas numpy tensorflow scikit-learn

      - name: Run Proactive Prediction Logic
        run: |
          python <<EOF
          import pandas as pd
          import numpy as np
          from tensorflow.keras.models import load_model
          import os

          # 1. Load the BRAIN (.h5 file)
          model_path = 'models/proactive_model_google_v1.h5'
          if os.path.exists(model_path):
              model = load_model(model_path, compile=False)
              print("âœ… Model (Brain) loaded successfully.")
          else:
              print(f"âŒ Error: Model missing at {model_path}")
              exit(1)

          # 2. Load the SYNTHETIC DATA (.csv file)
          data_path = 'data/synthetic_stress_test.csv'
          if os.path.exists(data_path):
              data = pd.read_csv(data_path)
              print(f"âœ… Synthetic data loaded from {data_path}")
          else:
              print(f"âŒ Error: Data missing at {data_path}")
              exit(1)

          # 3. Predict using the last 6 timestamps of synthetic data
          last_6_points = data['cpu_usage'].tail(6).values.reshape(1, 6, 1)
          prediction = model.predict(last_6_points)
          predicted_cpu = float(prediction[0][0])

          # 4. Scaling Decision Report
          THRESHOLD = 0.5 
          print(f"\n--- SYNTHETIC STRESS TEST REPORT ---")
          print(f"Predicted CPU Demand: {predicted_cpu:.4f}")
          if predicted_cpu > THRESHOLD:
              print("ðŸš¨ RESULT: SPIKE DETECTED. Action: Scaling up Pods!")
          else:
              print("âœ… RESULT: STABLE. Action: No scaling needed.")
          EOF